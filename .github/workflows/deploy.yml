name: Deploy to GCP Instance

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Verify authentication
        run: |
          echo "ðŸ”‘ Verificando autenticaciÃ³n..."
          gcloud auth list
          gcloud config list

      - name: Create deploy archive
        run: |
          echo "ðŸ“¦ Creando paquete de despliegue..."
          mkdir -p /tmp/deploy
          tar -czf /tmp/deploy/deploy.tar.gz \
            --exclude='.github' \
            --exclude='.git' \
            --exclude='*.log' \
            --exclude='*.tmp' \
            --exclude='*.temp' \
            --exclude='node_modules' \
            --exclude='.DS_Store' \
            .

      - name: Copy files to GCP instance
        run: |
          echo "ðŸš€ Copiando archivos a la instancia..."
          gcloud compute scp /tmp/deploy/deploy.tar.gz ${{ secrets.GCP_INSTANCE }}:/tmp/ --zone=${{ secrets.GCP_ZONE }} --quiet

      - name: Deploy on GCP instance
        run: |
          echo "ðŸ”§ Ejecutando despliegue remoto..."
          gcloud compute ssh ${{ secrets.GCP_INSTANCE }} \
            --zone=${{ secrets.GCP_ZONE }} \
            --command='
              set -e
              DEPLOY_DIR="/home/victor/ansible-scripts"
              TMP_TAR="/tmp/deploy.tar.gz"

              echo "ðŸ“‚ Creando directorios si no existen..."
              sudo mkdir -p "$DEPLOY_DIR" "$BACKUP_DIR"

              echo "ðŸ“¦ Extrayendo nuevos archivos..."
              sudo tar -xzf "$TMP_TAR" -C "$DEPLOY_DIR"

              echo "ðŸ§¹ Limpiando archivos temporales..."
              rm -f "$TMP_TAR"

              echo "âœ… Despliegue completado exitosamente"
            '
