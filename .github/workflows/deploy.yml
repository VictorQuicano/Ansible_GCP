name: Deploy to GCP Instance

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Verify authentication
        run: |
          echo "üîë Verificando autenticaci√≥n..."
          gcloud auth list
          gcloud config list

      - name: Create deploy archive
        run: |
          echo "üì¶ Creando paquete de despliegue..."
          mkdir -p /tmp/deploy
          tar -czf /tmp/deploy/deploy.tar.gz \
            --exclude='.github' \
            --exclude='.git' \
            --exclude='*.log' \
            --exclude='*.tmp' \
            --exclude='*.temp' \
            --exclude='node_modules' \
            --exclude='.DS_Store' \
            .
          mv /tmp/deploy/deploy.tar.gz .

      - name: Copy files to GCP instance
        run: |
          echo "üöÄ Copiando archivos a la instancia..."
          gcloud compute scp deploy.tar.gz ${{ secrets.GCP_USER }}@${{ secrets.GCP_INSTANCE }}:/tmp/ \
            --zone=${{ secrets.GCP_ZONE }} --quiet

      - name: Deploy on GCP instance
        run: |
          echo "üîß Ejecutando despliegue remoto..."
          gcloud compute ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_INSTANCE }} \
            --zone=${{ secrets.GCP_ZONE }} \
            --command='
              set -e
              DEPLOY_DIR="$HOME/anisble-scripts/html"
              BACKUP_DIR="$HOME/anisble-scripts/backups"
              TMP_TAR="/tmp/deploy.tar.gz"

              echo "üìÇ Creando directorios si no existen..."
              mkdir -p "$DEPLOY_DIR" "$BACKUP_DIR"

              echo "üì¶ Extrayendo nuevos archivos..."
              sudo tar -xzf "$TMP_TAR" -C "$DEPLOY_DIR"

              echo "üßπ Limpiando archivos temporales..."
              rm -f "$TMP_TAR"

              echo "üîê Ajustando permisos..."
              sudo chown -R www-data:www-data "$DEPLOY_DIR"
              sudo chmod -R 755 "$DEPLOY_DIR"

              echo "‚úÖ Despliegue completado exitosamente"
            '

      - name: Clean up local files
        run: rm -f deploy.tar.gz
